<!-- This can be used for both inbox.ejs and outbox.ejs -->
<div class="email-box">
  <div class="wrapper">
    <table>
      <thead>
        <tr>
          <th class="sender-recipient">
            <%= isInbox ? 'Sender' : 'Recipient' %>
          </th>
          <th>Content</th>
          <th>Time</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="3">Loading...</td>
        </tr>
      </tbody>
    </table>
    <div class="pagination"></div>
  </div>
</div>

<script>
  (function() {
    const isInbox = <%= isInbox %>;  // This should be set in your server-side route
    const emailType = isInbox ? 'received-email' : 'sent-email';
    const tableBody = document.querySelector("tbody");
    const pagination = document.querySelector(".pagination");

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function loadEmails(page = 1) {
      const userCookie = getCookie("user");
      if (!userCookie) {
        window.location.href = "/sign-in";
        return;
      }

      try {
        const user = JSON.parse(decodeURIComponent(userCookie));

        fetch(`/get/email/${emailType}/${user.userId}?page=${page}`, {
          credentials: "include"
        })
          .then(response => {
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
          })
          .then(data => {
            if (data.emails.length === 0) {
              tableBody.innerHTML = `<tr><td colspan="3" style="text-align: center">No emails found</td></tr>`;
            } else {
              let tableData = "";
              data.emails.forEach(row => {
                const time = new Date(row.sent_at);
                tableData += `
                  <tr>
                    <td class="sender-recipient">${isInbox ? row.sender : row.recipient}</td>
                    <td>
                      <div class="subject">
                        <a style="font-weight: bold" href="/email-detail/${row.emailId}">
                          ${row.subject || "No subject"}
                        </a>
                      </div>
                      <div class="body">${row.body}</div>
                    </td>
                    <td>${time.toLocaleString("en-us", {
                      month: "short",
                      day: "numeric",
                      year: "numeric"
                    })}</td>
                  </tr>
                `;
              });
              tableBody.innerHTML = tableData;
            }

            // Render pagination
            let paginationHtml = "";
            for (let i = 1; i <= data.pagination.totalPages; i++) {
              paginationHtml += `<a href="?page=${i}" class="${i === data.pagination.currentPage ? 'active' : ''}">${i}</a>`;
            }
            pagination.innerHTML = paginationHtml;
          })
          .catch(error => {
            console.error("Error:", error);
            tableBody.innerHTML = `<tr><td colspan="3">Error loading emails: ${error.message}</td></tr>`;
          });
      } catch (error) {
        console.error("Error parsing user data:", error);
        window.location.href = "/sign-in";
      }
    }

    // Initial load
    const urlParams = new URLSearchParams(window.location.search);
    const page = parseInt(urlParams.get('page')) || 1;
    loadEmails(page);

    // Add event listener for pagination clicks
    pagination.addEventListener('click', (e) => {
      if (e.target.tagName === 'A') {
        e.preventDefault();
        const page = parseInt(e.target.getAttribute('href').split('=')[1]);
        loadEmails(page);
        history.pushState(null, '', `?page=${page}`);
      }
    });
  })();
</script>
