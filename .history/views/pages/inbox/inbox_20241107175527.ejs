<div class="inbox">
  <div class="wrapper">
    <table>
      <thead>
        <tr>
          <th class="sender-recipient">Sender</th>
          <th>Content</th>
          <th>Time</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="pagination"></div>
  </div>
</div>

<script>
  // First, log all cookies to see what we have
  console.log("All cookies:", document.cookie);

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) {
      return parts.pop().split(";").shift();
    }
    return null;
  }

  // Check if user is logged in
  const userCookie = getCookie("user");
  console.log("User cookie:", userCookie);

  if (!userCookie) {
    // If no user cookie, redirect to login
    window.location.href = "/sign-in";
  } else {
    try {
      const user = JSON.parse(decodeURIComponent(userCookie));
      console.log("Parsed user:", user);

      const tableBody = document.querySelector("tbody");
      tableBody.innerHTML = '<tr><td colspan="3">Loading...</td></tr>';

      // Fetch emails
      fetch(`/get/email/received-email/${user.userId}`, {
        credentials: "include",
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then((data) => {
          let tableData = "";

          if (data.length === 0) {
            tableData = `<tr><td colspan="3" style="text-align: center">No emails found</td></tr>`;
            tableBody.innerHTML = tableData;
          } else {
            const totalPage = Math.ceil(data.length / 5);
            const queryParams = new URLSearchParams(window.location.search);
            const currentPage = parseInt(queryParams.get("page")) || 1;

            // Render pagination
            let paginationPage = "";
            for (let i = 1; i <= totalPage; i++) {
              paginationPage += `<a href="/inbox?page=${i}" class="${
                i === currentPage ? "active" : ""
              }">${i}</a>`;
            }
            pagination.innerHTML = paginationPage;

            // Render email rows for the current page
            data.forEach((row, index) => {
              if ((currentPage - 1) * 5 <= index && index < currentPage * 5) {
                const time = new Date(row.sent_at);
                tableData += `
                  <tr>
                    <td class="sender-recipient">${row.sender}</td>
                    <td>
                      <div class="subject">
                        <a style="font-weight: bold" href="/email-detail/${
                          row.emailId
                        }">
                          ${row.subject || "No subject"}
                        </a>
                      </div>
                      <div class="body">${row.body}</div>
                    </td>
                    <td>${time.toLocaleString("en-us", {
                      month: "short",
                      day: "numeric",
                      year: "numeric",
                    })}</td>
                  </tr>
                `;
              }
            });

            tableBody.innerHTML = tableData;
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          tableBody.innerHTML = `<tr><td colspan="3">Error loading emails: ${error.message}</td></tr>`;
        });
    } catch (error) {
      console.error("Error parsing user data:", error);
      window.location.href = "/sign-in";
    }
  }
</script>
