// views/inbox.ejs <%- include('layout') %>

<div class="inbox-container">
  <h1>Inbox</h1>

  <div class="email-controls">
    <button id="delete-selected" class="delete-btn" disabled>
      Delete Selected
    </button>
  </div>

  <div class="email-list">
    <% if (emails.length === 0) { %>
    <p>No emails in your inbox.</p>
    <% } else { %> <% emails.forEach(email => { %>
    <div class="email-item" data-email-id="<%= email.id %>">
      <div class="checkbox-container">
        <input
          type="checkbox"
          class="email-checkbox"
          data-id="<%= email.id %>"
        />
      </div>
      <div class="sender"><%= email.sender_name %></div>
      <a href="/email/<%= email.id %>" class="subject">
        <%= email.subject || '(no subject)' %>
      </a>
      <div class="time"><%= new Date(email.created_at).toLocaleString() %></div>
    </div>
    <% }); %> <% } %>
  </div>

  <div class="pagination">
    <% for(let i = 1; i <= totalPages; i++) { %>
    <a
      href="?page=<%= i %>"
      class="page-link <%= currentPage === i ? 'active' : '' %>"
    >
      <%= i %>
    </a>
    <% } %>
  </div>
</div>

<style>
  .inbox-container {
    max-width: 900px;
    margin: 0 auto;
  }

  .email-controls {
    margin: 20px 0;
  }

  .delete-btn {
    padding: 8px 16px;
    background-color: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    opacity: 0.6;
  }

  .delete-btn:enabled {
    opacity: 1;
  }

  .delete-btn:enabled:hover {
    background-color: #c82333;
  }

  .email-item {
    display: grid;
    grid-template-columns: 40px 200px 1fr 150px;
    padding: 15px;
    border-bottom: 1px solid #eee;
    align-items: center;
  }

  .email-item:hover {
    background-color: #f8f9fa;
  }

  .checkbox-container {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .subject {
    color: #333;
    text-decoration: none;
  }

  .subject:hover {
    text-decoration: underline;
  }

  .time {
    color: #666;
    font-size: 0.9em;
    text-align: right;
  }

  .pagination {
    margin-top: 20px;
    text-align: center;
  }

  .page-link {
    display: inline-block;
    padding: 8px 12px;
    margin: 0 4px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    text-decoration: none;
    color: #007bff;
  }

  .page-link.active {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
  }
</style>

<script>
  const deleteButton = document.getElementById("delete-selected");
  const checkboxes = document.querySelectorAll(".email-checkbox");

  // Enable/disable delete button based on checkbox selection
  document.addEventListener("change", function (e) {
    if (e.target.classList.contains("email-checkbox")) {
      const checkedBoxes = document.querySelectorAll(".email-checkbox:checked");
      deleteButton.disabled = checkedBoxes.length === 0;
    }
  });

  // Handle delete button click
  deleteButton.addEventListener("click", async function () {
    const selectedIds = Array.from(
      document.querySelectorAll(".email-checkbox:checked")
    ).map((checkbox) => checkbox.dataset.id);

    try {
      const response = await fetch("/api/emails/delete", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ ids: selectedIds }),
      });

      if (response.ok) {
        // Remove deleted emails from DOM
        selectedIds.forEach((id) => {
          const emailItem = document.querySelector(
            `.email-item[data-email-id="${id}"]`
          );
          emailItem.remove();
        });

        deleteButton.disabled = true;

        // Show success message
        const message = document.createElement("div");
        message.className = "alert alert-success";
        message.textContent = "Emails deleted successfully";
        document
          .querySelector(".inbox-container")
          .insertBefore(message, document.querySelector(".email-controls"));

        // Remove message after 3 seconds
        setTimeout(() => message.remove(), 3000);
      } else {
        throw new Error("Failed to delete emails");
      }
    } catch (error) {
      console.error("Error deleting emails:", error);
      alert("Failed to delete emails. Please try again.");
    }
  });
</script>
