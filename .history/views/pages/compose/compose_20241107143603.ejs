<%- include('/layout/layout.ejs') %>

<div class="compose-container">
  <h1>Compose Email</h1>

  <form id="compose-form" enctype="multipart/form-data">
    <div class="form-group">
      <label for="recipient">To:</label>
      <select id="recipient" name="recipient" required class="form-control">
        <option value="">Select recipient</option>
        <% users.forEach(user => { %>
        <option value="<%= user.id %>">
          <%= user.email %> (<%= user.full_name %>)
        </option>
        <% }); %>
      </select>
    </div>

    <div class="form-group">
      <label for="subject">Subject:</label>
      <input type="text" id="subject" name="subject" class="form-control" />
    </div>

    <div class="form-group">
      <label for="body">Message:</label>
      <textarea id="body" name="body" class="form-control" rows="10"></textarea>
    </div>

    <div class="form-group">
      <label for="attachment">Attachment:</label>
      <input
        type="file"
        id="attachment"
        name="attachment"
        class="form-control-file"
      />
    </div>

    <button type="submit" class="send-btn">Send</button>
  </form>
</div>

<style>
  .compose-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
  }

  .form-control {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
  }

  textarea.form-control {
    resize: vertical;
  }

  .form-control-file {
    padding: 8px 0;
  }

  .send-btn {
    padding: 10px 20px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
  }

  .send-btn:hover {
    background-color: #0056b3;
  }

  .alert {
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 4px;
  }

  .alert-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .alert-danger {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }
</style>

<script>
  document
    .getElementById("compose-form")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(this);

      try {
        const response = await fetch("/api/emails/send", {
          method: "POST",
          body: formData,
        });

        const result = await response.json();

        if (response.ok) {
          // Show success message
          const alert = document.createElement("div");
          alert.className = "alert alert-success";
          alert.textContent = "Email sent successfully!";
          this.insertBefore(alert, this.firstChild);

          // Clear form
          this.reset();

          // Remove success message after 3 seconds
          setTimeout(() => alert.remove(), 3000);
        } else {
          throw new Error(result.message || "Failed to send email");
        }
      } catch (error) {
        console.error("Error sending email:", error);
        const alert = document.createElement("div");
        alert.className = "alert alert-danger";
        alert.textContent =
          error.message || "Failed to send email. Please try again.";
        this.insertBefore(alert, this.firstChild);
      }
    });
</script>
